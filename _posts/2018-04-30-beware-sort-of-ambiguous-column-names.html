---
layout: post
title: Beware (Sort-Of) Ambiguous Column Names In Sub-Selects
date: '2018-04-30T12:55:00.000-05:00'
author: Don Seiler
tags:
- mysql
- oracle
- postgresql
- mssql
- sql
modified_time: '2018-05-02T13:01:46.568-05:00'
blogger_id: tag:blogger.com,1999:blog-7032512792942232766.post-727993782011343408
blogger_orig_url: http://www.seiler.us/2018/04/beware-sort-of-ambiguous-column-names.html
---

This morning I received an UPDATE statement from a developer that I was testing. It ran without errors but then I saw that it updated 5 rows when it should have only updated 3. The reason gave me a little shock so I whipped up a simple test-case to reproduce the problem.<br /><br />First we create two tables:<br /><br /><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">CREATE TABLE foo (</span><br /><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">&nbsp; &nbsp; id int</span><br /><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">&nbsp; &nbsp; , name varchar(30)</span><br /><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">);</span><br /><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">CREATE TABLE</span><br /><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">CREATE TABLE bar (</span><br /><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">&nbsp; &nbsp; id int</span><br /><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">&nbsp; &nbsp; , foo_id int</span><br /><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">&nbsp; &nbsp; , description varchar(100)</span><br /><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">);</span><br /><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">CREATE TABLE</span><br /><br />Then we insert some data:<br /><br /><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">INSERT INTO foo (id, name) VALUES</span><br /><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">&nbsp; &nbsp; (1, 'Dev')</span><br /><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">&nbsp; &nbsp; , (2, 'QA')</span><br /><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">&nbsp; &nbsp; , (3, 'Preprod')</span><br /><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">&nbsp; &nbsp; , (4, 'Prod');</span><br /><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">INSERT 0 4</span><br /><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">INSERT INTO bar (id, foo_id, description)</span><br /><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">&nbsp; &nbsp; VALUES (1, 1, 'A')</span><br /><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">&nbsp; &nbsp; , (2, 2, 'B')</span><br /><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">&nbsp; &nbsp; , (3, 2, 'C')</span><br /><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">&nbsp; &nbsp; , (4, 2, 'D')</span><br /><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">&nbsp; &nbsp; , (5, 3, 'E');</span><br /><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">INSERT 0 5</span><br /><br />Here I'm using a SELECT rather than the original UPDATE just to test. This could (should) be done as a join, but I was sent something like this:<br /><br /><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">SELECT COUNT(*)</span><br /><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">FROM bar</span><br /><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">WHERE foo_id = (SELECT id FROM foo WHERE name='QA');</span><br /><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">&nbsp;count</span><br /><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">-------</span><br /><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">&nbsp; &nbsp; &nbsp;3</span><br /><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">(1 row)</span><br /><br />Fair enough. It does the same thing as a join. However what I was sent was actually this (note the column name in the subquery):<br /><br /><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">SELECT COUNT(*)</span><br /><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">FROM bar</span><br /><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">WHERE foo_id = (SELECT foo_id FROM foo WHERE name='QA');</span><br /><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">&nbsp;count</span><br /><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">-------</span><br /><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">&nbsp; &nbsp; &nbsp;5</span><br /><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">(1 row)</span><br /><br />I would expect an error since foo_id does not exist in table foo, like this:<br /><br /><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">SELECT foo_id FROM foo WHERE name='QA';</span><br /><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">ERROR:&nbsp; 42703: column "foo_id" does not exist</span><br /><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">LINE 1: SELECT foo_id FROM foo WHERE name='QA';</span><br /><br />Instead, it basically selected EVERYTHING in the bar table. Why?<br /><br />I posted this dilemma in the PostgreSQL Slack channel, and others were similarly surprised by this. <a href="http://ryanguill.com/" target="_blank">Ryan Guill</a> tested and confirmed the same behavior not only in Postgres, but also in Oracle, MS SQL, &amp; MySQL.<br /><br /><a href="http://rainwatr.blogspot.com/" target="_blank">Cindy Wise</a> observed that it is probably using the foo_id field from the bar table in the outer query, which does make sense. It's comparing foo_id to itself (while also running the almost-but-not-quite-entirely-pointless subquery to foo table), which will of course return true, so it grabs every row in the bar table.<br /><br />This seems like a very easy trap to fall into if you're not careful with your column names. Considering this was originally in the form of an UPDATE query, it can be a destructive mistake that would execute successfully and could be rather hard to trace back.
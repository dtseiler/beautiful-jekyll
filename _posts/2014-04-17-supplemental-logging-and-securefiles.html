---
layout: post
title: Supplemental Logging and Securefiles Causing DBWn to Block
date: '2014-04-17T09:00:00.000-05:00'
author: Don Seiler
tags:
- securefile
- golden gate
- 11gR2
- log miner
- clob
- oracle
modified_time: '2014-04-17T09:00:00.302-05:00'
blogger_id: tag:blogger.com,1999:blog-7032512792942232766.post-7522313585687243519
blogger_orig_url: http://www.seiler.us/2014/04/supplemental-logging-and-securefiles.html
---

A few weeks back, we began making changes to prepare for using Oracle Golden Gate. One of the first steps required is to enable "minimal supplemental logging" at the database level. We did this during an evening maintenance window. However by the time the morning workload picked up, we started seeing a lot of sessions blocking, and the root blocker was one of the DB Writer (DBWn) processes.<br /><br />Looking at the blocked sessions, a query similar to this was a common theme:<br /><br /><span style="font-family: &quot;Courier New&quot;,Courier,monospace;"><span style="font-size: small;">UPDATE foo</span></span><br /><span style="font-family: &quot;Courier New&quot;,Courier,monospace;"><span style="font-size: small;">SET foo_data = :data, foo_time = systimestamp</span></span><br /><span style="font-family: &quot;Courier New&quot;,Courier,monospace;"><span style="font-size: small;">WHERE foo_id = :id</span></span><br /><br />This statement was run by many sessions from our webservers as part of a page load process. Very high-frequency call rate. We knew that the only change in the database was the minimal supplemental logging. Obviously we were preparing to turn it off, but took some time to look into it. It is important to note that for the most part the contention was only with sessions running this update statement.<br /><br /><a name='more'></a><br /><br />Looking at the table involved, one unique feature was that foo_data field is an encrypted CLOB, which Oracle refers to as a securefile in 11g.<br /><br /><span style="font-family: &quot;Courier New&quot;,Courier,monospace;">SQL&gt; desc foo</span><br /><span style="font-family: &quot;Courier New&quot;,Courier,monospace;"> Name&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp; &nbsp; Null? &nbsp;&nbsp;   Type</span><br /><span style="font-family: &quot;Courier New&quot;,Courier,monospace;"> --------------- -------- ----------------------------</span><br /><span style="font-family: &quot;Courier New&quot;,Courier,monospace;"> FOO_ID &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;NOT NULL VARCHAR2(64)</span><br /><span style="font-family: &quot;Courier New&quot;,Courier,monospace;"> FOO_DATA &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; CLOB ENCRYPT</span><br /><span style="font-family: &quot;Courier New&quot;,Courier,monospace;"> FOO_TIME &nbsp; &nbsp; &nbsp; &nbsp;NOT NULL TIMESTAMP(6)</span><br /><br /><span style="text-align: left; width: 575px;">We opened an SR with Oracle and they pointed us to this unpublished bug:</span><br /><span style="text-align: left; width: 575px;"><br /></span><span style="text-align: left; width: 575px;"><br /></span><span style="text-align: left; width: 575px;"><b>Bug 9351684  : SECUREFILE - CACHE NOLOGGING CAUSES HIGH WRITE COMPLETE WAITS</b> <br />  <br />They described it for us as:</span><br /><blockquote class="tr_bq"><span style="text-align: left; width: 575px;">Confirmed as "not a bug" in this bug.<br /> </span><span style="text-align: left; width: 575px;"><br /></span><span style="text-align: left; width: 575px;"> It was stated:  "write complete waits in this case are unfortunately, expected and can not be avoided/tuned. Even for NOLOGGING case there is a short invalidation redo that must be generated, and for correct crash recovery, dbwr must wait for redo to be written to disk first before data blocks can be written."</span></blockquote>Basically telling us that this is working as intended and there is no workaround if you're using securefiles. For us it was important that we move forward with Golden Gate, so we would need to have a solution that let us keep minimal supplemental logging on. Looking closer, we knew that this table was on an encrypted tablespace already, so we felt comfortable changing the table so that it used a regular "basicfile" CLOB:<br /><br /><span style="font-family: &quot;Courier New&quot;,Courier,monospace;">SQL&gt; desc foo<br /> Name &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;                                     Null?&nbsp;&nbsp;&nbsp;    Type<br /> --------------- -------- ----------------------------<br /> FOO_ID &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;NOT NULL VARCHAR2(64)<br /> FOO_DATA &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; CLOB<br /> FOO_TIME &nbsp; &nbsp; &nbsp; &nbsp;NOT NULL TIMESTAMP(6) </span><br /><br />Since making this change, the problems have gone away. Obviously we were lucky in that we could change the table to not use securefiles. If you have a table that sees a lot of DML with securefiles, you're probably going to have a painful experience with supplemental logging. Beware!
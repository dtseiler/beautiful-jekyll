---
layout: post
title: 'Learning to Love the ADR - Part 3: Purging (Out With The Old)'
date: '2013-01-30T19:00:00.000-06:00'
author: Don Seiler
tags:
- 11g
- dba
- ADR
- oracle
- diagnostics
modified_time: '2013-01-31T08:47:20.239-06:00'
blogger_id: tag:blogger.com,1999:blog-7032512792942232766.post-7131913806636502068
blogger_orig_url: http://www.seiler.us/2013/01/learning-to-love-adr-part-3-purging-out.html
---

<br /><i style="background-color: white; color: #666666; font-family: 'Trebuchet MS', Trebuchet, Verdana, sans-serif; font-size: 13px; line-height: 18px;">This post is the third in a short series about Oracle 11g ADR. These posts are based on the presentations I gave at the NoCOUG Summer Conference in August 2011 and at the RMOUG Training Days in February 2012.</i><br /><br />One of the benefits of the new ADR system is the automatic file maintenance (archiving and cleanup) that I mentioned earlier. Depending on the type of file it is, XML log and trace file maintenance is governed by either the long or short purge policy. The values of these policies can be observed from the ADRCI command "show control", e.g.:<br /><br /><br /><span style="font-family: Courier New, Courier, monospace;">adrci&gt; show control</span><br /><span style="font-family: Courier New, Courier, monospace;"><br /></span><span style="font-family: Courier New, Courier, monospace;">ADR Home = /home/oracle/app/oracle/diag/rdbms/orcl/orcl:</span><br /><span style="font-family: Courier New, Courier, monospace;">*************************************************************************</span><br /><span style="font-family: Courier New, Courier, monospace;">ADRID &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<b><span style="color: red;">SHORTP_POLICY</span></b>&nbsp;&nbsp; &nbsp; &nbsp; &nbsp;<b><span style="color: red;">LONGP_POLICY</span></b>&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; LAST_MOD_TIME &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;LAST_AUTOPRG_TIME &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;LAST_MANUPRG_TIME &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;ADRDIR_VERSION &nbsp; &nbsp; &nbsp; ADRSCHM_VERSION &nbsp; &nbsp; &nbsp;ADRSCHMV_SUMMARY &nbsp; &nbsp; ADRALERT_VERSION &nbsp; &nbsp; CREATE_TIME</span><br /><span style="font-family: Courier New, Courier, monospace;">-------------------- -------------------- -------------------- ---------------------------------------- ---------------------------------------- ---------------------------------------- -------------------- -------------------- -------------------- -------------------- ----------------------------------------</span><br /><span style="font-family: Courier New, Courier, monospace;">1335663986 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;<b><span style="color: red;">720</span></b>&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span style="color: red;"><b>8760</b></span>&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 2012-03-28 09:46:07.813608 -05:00 &nbsp; &nbsp; &nbsp; &nbsp;2012-09-18 22:19:08.939553 -05:00 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 1 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;2 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;80 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 1 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;2012-03-28 09:46:07.813608 -05:00</span><br /><div><br /></div><br />I've highlighted the column names and values in red. It doesn't format very well in the terminal either.<br /><br />Let's break it down.<br /><br /><a name='more'></a><br /><br /><h3>Short Purge Policy - SHORTP_POLICY</h3>The short purge policy governs files that usually need to be retained for only a short period of time. This includes trace files, core dumps and packaging information files (from IPS, which we'll cover later).<br /><br />This policy is identified by the name "SHORTP_POLICY" and the value is represented in hours. The default SHORTP_POLICY is 720 hours, or 30 days. The maximum value is 35,791,394 hours, which is over 4,000 years. Hopefully you don't need any more time than this to retain your files. You can set the value to 0 to indicate that all files under this policy are immediately available for purging.<br /><br />To set this value, you must use the "set control" command in ADRCI. For example, to set it to 168 hours (7 days), we would use this command:<br /><br /><span style="font-family: Courier New, Courier, monospace;">adrci&gt; set control (shortp_policy=168);</span><br /><br /><h3>Long Purge Policy - LONGP_POLICY</h3><div>Alert logs, incident info and incident dump files are all governed by the long purge policy, known by LONGP_POLICY in the ADR. The default retention time is 8,760 hours, or 365 days. It has the same maximum value as the short purge policy, and similar behavior when the value is set to zero. Similarly, to set the value for LONGP_POLICY to 1,440 hours (60 days):</div><div><br /></div><div><span style="font-family: Courier New, Courier, monospace;">adrci&gt; set control (longp_policy=1440);</span></div><div><span style="font-family: Courier New, Courier, monospace;"><br /></span></div><span style="font-family: inherit;">You can use show control again to view the new settings:</span><br /><div><span style="font-family: Courier New, Courier, monospace;"><br /></span></div><div><div><span style="font-family: Courier New, Courier, monospace;">adrci&gt; show control;</span></div><div><span style="font-family: Courier New, Courier, monospace;"><br /></span></div><div><span style="font-family: Courier New, Courier, monospace;">ADR Home = /home/oracle/app/oracle/diag/rdbms/orcl/orcl:</span></div><div><span style="font-family: Courier New, Courier, monospace;">*************************************************************************</span></div><div><span style="font-family: Courier New, Courier, monospace;">ADRID &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;SHORTP_POLICY &nbsp; &nbsp; &nbsp; &nbsp;LONGP_POLICY &nbsp; &nbsp; &nbsp; &nbsp; LAST_MOD_TIME &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;LAST_AUTOPRG_TIME &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;LAST_MANUPRG_TIME &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;ADRDIR_VERSION &nbsp; &nbsp; &nbsp; ADRSCHM_VERSION &nbsp; &nbsp; &nbsp;ADRSCHMV_SUMMARY &nbsp; &nbsp; ADRALERT_VERSION &nbsp; &nbsp; CREATE_TIME</span></div><div><span style="font-family: Courier New, Courier, monospace;">-------------------- -------------------- -------------------- ---------------------------------------- ---------------------------------------- ---------------------------------------- -------------------- -------------------- -------------------- -------------------- ----------------------------------------</span></div><div><span style="font-family: Courier New, Courier, monospace;">1335663986 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;<b><span style="color: red;">168</span></b>&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span style="color: red;"><b>1440</b></span>&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 2012-12-28 14:18:02.894677 -06:00 &nbsp; &nbsp; &nbsp; &nbsp;2012-09-18 22:19:08.939553 -05:00 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 1 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;2 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;80 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 1 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;2012-03-28 09:46:07.813608 -05:00</span></div><div><span style="font-family: Courier New, Courier, monospace;">1 rows fetched</span></div></div><div><br /></div><h3>Purge Job</h3><div>Now just because a file is eligible to be purged doesn't mean it will be purged soon. It means they will be purged when the instance's purge job runs next, and that could take up to a week. The purge job is an MMON slave task, and only runs once every 7 days, according to MOS Doc ID 975448.1. So don't play around with the long or short policy values thinking they will trigger an instant cleanup (like you would expect if you changed the FRA size below the current used space).</div><div><br /></div><div>There is however a known bug (9500575) that affects Oracle 11.1.0.7 &amp; 11.2.0.1 where alert log XML files for listeners are not automatically purged. This has the potential then to fill up the disk where these logs are written to.</div><div><br /></div><h3>PURGE Command</h3><div>You can manually purge files from ADRCI with the PURGE command. One common use is to purge files of a certain type older than a certain age. For example, to overcome the listener log purge bug that was just mentioned, you could schedule this to run weekly (ADRCI can be called from the command-line or cron with commands to run):</div><div><br /></div><div><span style="font-family: Courier New, Courier, monospace;">adrci&gt; purge -age 10080 -type alert;</span></div><div><br /></div><div>This purges all alert logs older than 10,080 minutes. Note that the -age parameter here is in minutes, where as the policy values are in hours.<br /><br />Similarly you could choose to purge all files for a specific incident ID (assuming you are certain you don't need them and can't wait for them to automatically be purged out) with the -i option:<br /><br /><span style="font-family: Courier New, Courier, monospace;">adrci&gt; purge -i 13579;</span></div><div><br /></div><div>For more options, type "help purge" at the ADRCI prompt. I can't stress enough how good the ADRCI help facility is.</div><div><br /></div><div></div>
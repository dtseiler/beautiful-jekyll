---
layout: post
title: Analytics FTW
date: '2006-12-06T15:19:00.000-06:00'
author: Don Seiler
tags:
- analytics
- oracle
modified_time: '2010-11-19T22:48:47.968-06:00'
blogger_id: tag:blogger.com,1999:blog-7032512792942232766.post-7308969367251574643
blogger_orig_url: http://www.seiler.us/2006/12/analytics-ftw.html
---

Today I was presented with this query:<br /><pre>SELECT *<br />FROM sid_batch<br />WHERE(loc, from_sid, sid_bid, type, add_date, batch_no) IN<br />(SELECT loc,<br />from_sid,<br />sid_bid,<br />type,<br />add_date,<br />MAX(batch_no)<br />FROM sid_batch<br />WHERE(loc, from_sid, sid_bid, type, add_date) IN<br />(SELECT loc,<br />  from_sid,<br />  sid_bid,<br />  type,<br />  MAX(add_date)<br />FROM sid_batch<br />WHERE loc = '004'<br />AND from_sid = '60056'<br />AND status <> 'I'<br />AND type <> 'A'<br />GROUP BY loc,<br />  from_sid,<br />  sid_bid,<br />  type)<br />AND loc = '004'<br />AND from_sid = '60056'<br />AND status <> 'I'<br />AND type <> 'A'<br />GROUP BY loc,<br />from_sid,<br />sid_bid,<br />type,<br />add_date)<br />AND loc = '004'<br />AND from_sid = '60056'<br />AND status <> 'I'<br />AND type <> 'A'<br />ORDER BY loc,<br />from_sid DESC,<br />sid_bid DESC,<br />type DESC,<br />batch_no DESC;</pre>Now I know almost nothing of <a href="http://download-east.oracle.com/docs/cd/B19306_01/server.102/b14223/analysis.htm#i1007779">analytics</a>, but I did recognize that this sort of thing is exactly what they are for.  In this case, the user wants to get the records that contain the highest batch_no for the highest add_date for a given loc, from_sid, sid_bid and type.<br /><br />After a bit of research and chatting with <a href="http://halisway.blogspot.com/">hali</a>, I trial-and-errored my way to this:<br /><pre>SELECT *<br />FROM<br />(SELECT sid_batch.*,<br />      rank() over(PARTITION BY loc,from_sid,sid_bid,type<br />        ORDER BY add_date DESC, batch_no DESC) rank<br />FROM sid_batch<br />WHERE loc = '004'<br />AND from_sid = '60056'<br />AND status <> 'I'<br />AND type <> 'A')<br />WHERE rank = 1<br />ORDER BY loc,<br />from_sid DESC,<br />sid_bid DESC,<br />type DESC,<br />batch_no DESC;</pre>The first thing you should notice is that it is a LOT cleaner looking.  Basically all the work is done in the one query, I just use the outer query to pick the #1 ranked rows and sort them.<br /><br />The key is the rank() function.  What rank() does is provide a numerical ranking based on a group of criteria (the PARTITION BY clause) and an order (the ORDER BY clause).  In this case I say that for every set of loc, from_sid, sid_bid and type, rank the records of that set first by most recent add_date, and then by highest batch_no.  This means the the highest batch_no for the highest add_date in that set will be ordered first, with a rank of 1.  In my outer query I can then just choose the records with rank=1 and be on my way.<br /><br />The query plan is MUCH cleaner as well.  No messy hashes or nested loops, and, while the cost wasn't too bad at all (6), I cut it in half.
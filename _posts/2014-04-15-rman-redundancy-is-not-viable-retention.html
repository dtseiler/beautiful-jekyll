---
layout: post
title: RMAN Redundancy is not a Viable Retention Policy
date: '2014-04-15T14:07:00.001-05:00'
author: Don Seiler
tags:
- rman
- oracle
- 10gR2
modified_time: '2014-04-15T14:11:46.419-05:00'
blogger_id: tag:blogger.com,1999:blog-7032512792942232766.post-6373715109356726373
blogger_orig_url: http://www.seiler.us/2014/04/rman-redundancy-is-not-viable-retention.html
---

<div style="margin-bottom: 0.5em; margin-top: 0.5em;"><br /><span style="font-size: xx-small;"><i><a class="vt-p" href="http://www.pythian.com/blog/rman-redundancy-is-not-a-viable-retention-policy/">Originally posted by me on the Pythian blog</a>. This is an older post that I somehow forgot to post on my own blog, but another recent redundancy foul-up reminded me of it.</i></span><br /><br />The story you are about to read is based on actual events. Names and paths have been changed to protect the innocent. I call this scenario “The Perfect Storm” because it took just the right combination of events and configurations. Sadly, this doesn’t make it an unlikely occurrence, so I’m posting it here in hopes that you’ll be able to save yourselves before it’s too late.<br /><br />I have always had a preternatural dislike for using REDUNDANCY as a retention policy for Oracle RMAN, greatly preferring RECOVERY WINDOW instead, simply because REDUNDANCY doesn’t really guarantee anything valuable to me, whereas RECOVERY WINDOW guarantees that I’ll be able to do a point-in-time recovery to anytime within the past x days. Plus, I had already been burned once by a different client using REDUNDANCY. With the story I’m about to tell, this dislike has turned into violent hatred. I’m going to be light on the technical details, but I hope you’ll still feel the full pain.<br /><br /><a name='more'></a><br /><br />First some table setting:<br /><ul><li>Standalone 10.2.0.2 instance (no RAC, no DataGuard/Standby)</li><li>RMAN retention policy set to REDUNDANCY 2</li><li>Backups stored in the Flash Recovery Area (FRA)</li></ul>A few months ago, we had a datafile corruption on this relatively new instance (data had been migrated from an old server about a week prior). The on-call DBA followed up the page by checking for corruptions in the datafile with this command:<br /><br /><span style="font-family: Courier New, Courier, monospace;">RMAN&gt; backup check logical datafile '/path/to/foobar_data.dbf';</span><br /><br />This, my friends, led to the major fall, though we did not know it for many hours. You see, the FRA was already almost full. This causes the FRA to automatically delete obsolete files to free up space. That last backup command, while only intended to check for logical corruption, did actually perform a backup of the file, and rendered the earliest backup of the file obsolete since there were two newer copies. That earliest file happened to be from the level 0 backup from which we would later want to restore.<br /><br />Of course, at first we didn’t know why the file was missing. Logs showed that it was on disk no less than two hours before the problem started. Later, scanning the alert log for the missing backup filename yielded this:<br /><br /><span style="font-family: Courier New, Courier, monospace;">Deleted Oracle managed file /path/to/flash_recovery_area/FOO_DB/backupset/2008_12_01/o1_xxxx.bkp</span><br /><br />Oracle deleted the one backup file that we needed!<br /><br />Even worse, it wasn’t until this time on a Monday night that we realized that the level 0 taken the previous weekend had failed to push the backup files to tape because of a failure on the NetBackup server. The problem was reported as part of Monday morning’s routine log checks, but the missing files had not yet been pushed to tape.<br /><br />In the end, we were able to drop and restore the tablespace to a previous point in time on a test instance from another backup file and exp/imp data back over. It was ugly, but it got things back online. Many DBAs better than myself gave their all on this mission.<br /><br />To summarize, the ingredients:<br /><ul><li>Oracle RMAN</li><li>CONFIGURE RETENTION POLICY TO REDUNDANCY 2;</li><li>Flash Recovery Area near full, obediently deleting obsolete files.</li><li>Tape backup failure</li></ul>Add in an innocent backup command and . . . BOOM! Failure Surprise.<br /><br />The two biggest points to take away are<span style="background-color: white; color: #343434; font-family: proxima-nova, Verdana, Arial, sans-serif; font-size: 14.399999618530273px; line-height: 1.5em;">:</span><br /><br /><ul><li>Tape backup failures are still serious backup failures and should be treated as such, even if you backup to disk first.</li><li>REDUNDANCY is not a viable retention policy. In my house, it is <i>configuration non grata</i>.</li></ul></div>
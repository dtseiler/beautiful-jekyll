---
layout: post
title: Turn Off db_cache_advice To Avoid Latch Contention Bugs
date: '2009-08-26T16:06:00.000-05:00'
author: Don Seiler
tags: 
modified_time: '2010-11-20T11:30:37.447-06:00'
blogger_id: tag:blogger.com,1999:blog-7032512792942232766.post-4426775554330440379
blogger_orig_url: http://www.seiler.us/2009/08/turn-off-dbcacheadvice-to-avoid-latch.html
---

<em>Originally posted on <a href="http://www.pythian.com/news/2838/turn-off-db_cache_advice-to-avoid-latch-contention-bugs">The Pythian Group blog</a>.</em><br /><br />A couple of weeks ago, we noticed some timeouts in some of our standard Oracle RDBMS health check scripts on a new instance. I had just migrated this instance to bigger, better, badder hardware and so it had been given more SGA to use, namely a bigger buffer cache. The software version was still Oracle 10.2.0.2, as we wanted to introduce as few variables as possible (we were already moving to a new platform with an <a href="http://en.wikipedia.org/wiki/Endianness">endian</a> change).<br /><br />At first the timeouts were infrequent, but over the course of a week started to grow in frequencey until the point where none of the checks were finishing in the allowed timeframe. We ran an AWR report, and tucked far down in the “Latch Activity” section, a colleague noticed this:<br /><pre>Pct    Avg   Wait                 Pct<br />                                    Get    Get   Slps   Time       NoWait NoWait<br />Latch Name                     Requests   Miss  /Miss    (s)     Requests   Miss<br />------------------------ -------------- ------ ------ ------ ------------ ------<br />...<br /><strong>simulator lru latch          10,032,617    3.3    0.7  44950      336,837    0.3</strong><br />...<br /> Latch Activity                             DB/Inst: FOO/foo  Snaps: 156-157<br />-&gt; "Get Requests", "Pct Get Miss" and "Avg Slps/Miss" are statistics for<br />   willing-to-wait latch get requests<br />-&gt; "NoWait Requests", "Pct NoWait Miss" are for no-wait latch get requests<br />-&gt; "Pct Misses" for both should be very close to 0.0<br /><br />                                           Pct    Avg   Wait                 Pct<br />                                    Get    Get   Slps   Time       NoWait NoWait<br />Latch Name                     Requests   Miss  /Miss    (s)     Requests   Miss<br />------------------------ -------------- ------ ------ ------ ------------ ------<br />transaction branch alloc        112,412    0.0    0.0      0            0    N/A<br />undo global data                466,321    0.0    0.0      0            0    N/A<br />user lock                         7,440    0.8    0.4      1            0    N/A<br />          -------------------------------------------------------------</pre>The “simulator lru latch” event brought us to MetaLink note 5918642.8 and bug 5918642. Affecting 10g and 11g prior to 10.2.0.4 and 11.1.0.7, respectively. The bug is with the database buffer cache advisor, controlled by the parameter <a href="http://download.oracle.com/docs/cd/B19306_01/server.102/b14237/initparams042.htm#sthref126">db_cache_advice</a>, which defaults to ON (depending on statistics_level).  The note simply states:<br /><blockquote>High simulator lru latch contention can occur when db_cache_advice is set to ON if there is a large buffer cache.</blockquote>We simply set db_cache_advice to OFF (thankfully it is a dynamic parameter), and pretty quickly our checks were running just fine.<br /><br />My suggestion is to simply turn this off unless you are actively using the cache advisor to tune an instance. Once you are done tuning, and are no longer using the advisor, turn it off.<br /><br />NOTE: &nbsp;As Mladen Gogola pointed out in the comments, turning this off will cause problems if you are using automatic memory management (i.e. sga_target &gt; 0). &nbsp; Re-pasting his post here:<br /><blockquote>The problem with that advice is that it will prevent automatic memory management from resizing the buffer cache and the instance will end up with a huge, mostly empty, shared pool and default buffer cache. Automatic memory management is biased toward shared pool even with the cache dvice turned on, without it, buffer cache will be reduced to the minimum size, usually only 64MB. If you disable cache advice, I would also recommend disabling the automatic memory management and configuring SGA manually.</blockquote>
---
layout: post
title: Migrating (and Upgrading!) Your EM12c Repository Database
date: '2014-04-07T08:00:00.000-05:00'
author: Don Seiler
tags:
- em12c
- 11gR2
- rman
- upgrade
- migration
- oracle
modified_time: '2014-04-07T12:18:31.422-05:00'
blogger_id: tag:blogger.com,1999:blog-7032512792942232766.post-5217012756501146498
blogger_orig_url: http://www.seiler.us/2014/04/migrating-and-upgrading-your-em12c.html
---

This week I migrated our EM12c repository database to a new server as part of its promotion to production status. Just to make it a little more exciting, the migration also involved an in-flight upgrade from 11.2.0.3 to 11.2.0.4. Much of this post is directly inspired by <a class="vt-p" href="http://martincarstenbach.wordpress.com/2011/10/17/move-the-em12c-repository-database/" target="_blank">Martin Bach's post on the same subject</a>. I ran into a few other snags that weren't mentioned so I thought it would be worthwhile to document the experience here for your benefit.<br /><br />I'm assuming you have all the software installed (and patched to the latest PSU, right?). Alright then, let's begin!<br /><br /><a name='more'></a><h3>Stop OMS</h3><div>We want to make sure there are no more changes coming, and nothing needs to access the repository database, so be sure to stop all OMS instances:</div><div><br /></div><div><span style="font-family: Courier New, Courier, monospace;">$ emctl stop oms -all</span></div><div><br /></div><h3>Backup PFILE</h3><div>We need to get the pfile for the current repo and copy it into place on new host:</div><div><br /></div><div><span style="font-family: Courier New, Courier, monospace;">SQL&gt; create pfile='/mnt/emrepo_backup/initemrepo.ora' from spfile;</span></div><div><br /></div><div>I use /mnt/emrepo_backup here because that is the directory that I'll be backing the database up to and copying to the new host after. If you create your pfile somewhere else, be sure to copy it to the new host under $ORACLE_HOME/dbs/</div><h3></h3><h3>Backup Repo Database</h3><div>Next we backup the repo database. Here's a snippet from my ksh script that I used:</div><div><br /></div><br /><div><span style="font-family: Courier New, Courier, monospace;">#!/bin/ksh</span></div><div><span style="font-family: Courier New, Courier, monospace;"><br /></span></div><div><span style="font-family: Courier New, Courier, monospace;">BACKUPDIR=/mnt/emrepo_backup</span></div><div><div><span style="font-family: Courier New, Courier, monospace;">LOGFILE=backup_emrepo.log</span></div><div><span style="font-family: Courier New, Courier, monospace;"><br /></span></div><div><span style="font-family: Courier New, Courier, monospace;">mkdir -p $BACKUPDIR</span></div><div><span style="font-family: Courier New, Courier, monospace;"><br /></span></div><div><span style="font-family: Courier New, Courier, monospace;">rman log=$LOGFILE &lt;&lt;EOF</span></div><div><span style="font-family: Courier New, Courier, monospace;">connect target /</span></div><div><span style="font-family: Courier New, Courier, monospace;">set echo on</span></div><div><span style="font-family: Courier New, Courier, monospace;"><br /></span></div></div><br /><div><span style="font-family: Courier New, Courier, monospace;">run {</span></div><br /><div><span style="font-family: Courier New, Courier, monospace;">&nbsp; &nbsp; &nbsp; &nbsp; allocate channel c1 device type disk format '$BACKUPDIR/%U';</span></div><div><div><span style="font-family: Courier New, Courier, monospace;">&nbsp; &nbsp; &nbsp; &nbsp; allocate channel c2 device type disk format '$BACKUPDIR/%U';</span></div><div><span style="font-family: Courier New, Courier, monospace;">&nbsp; &nbsp; &nbsp; &nbsp; allocate channel c3 device type disk format '$BACKUPDIR/%U';</span></div><div><span style="font-family: Courier New, Courier, monospace;">&nbsp; &nbsp; &nbsp; &nbsp; allocate channel c4 device type disk format '$BACKUPDIR/%U';</span></div><div><span style="font-family: Courier New, Courier, monospace;"><br /></span></div><div><span style="font-family: Courier New, Courier, monospace;">&nbsp; &nbsp; &nbsp; &nbsp; backup as compressed backupset database</span></div><div><span style="font-family: Courier New, Courier, monospace;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; include current controlfile</span></div><div><span style="font-family: Courier New, Courier, monospace;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; plus archivelog;</span></div></div><div><span style="font-family: Courier New, Courier, monospace;">}</span></div><div><span style="font-family: Courier New, Courier, monospace;">EOF</span></div><div><br /></div><div>When the backup is finished, review the RMAN log and make note of which backup piece contains the controlfile backup. We'll need to refer to it by name as part of the restore process.</div><div><br /></div><div>If your backup directory is an NFS mount, then you can simply unmount it from here and mount it to the new server. Otherwise, be sure to copy the files there after the backup is complete, for example:</div><div><br /></div><div><span style="font-family: Courier New, Courier, monospace;">$ scp -r /mnt/emrepo_backup newhost:/path/to/emrepo_backup</span></div><div><br /></div><div>After this, it should be safe to shutdown the old repository database.</div><div><br /></div><div><span style="font-family: Courier New, Courier, monospace;">$ sqlplus / as sysdba</span></div><div><span style="font-family: Courier New, Courier, monospace;">SQL&gt; shutdown immediate</span></div><div><br /></div><div>If you use Oracle Restart:</div><div><br /></div><div><span style="font-family: Courier New, Courier, monospace;">$ srvctl stop database -d emrepo</span></div><div><span style="font-family: Courier New, Courier, monospace;">$ srvctl disable database -d emrepo</span></div><div><br /></div><h3>Prepare New Host for Repo DB</h3><div>Now we need to set things up on the new host for the emrepo DB.</div><div><br /></div><h4>Create oratab Entry</h4><div>First let's create an entry in /etc/oratab for this DB under the new 11.2.0.4 home. For example:</div><div><div><br /></div><div><span style="font-family: Courier New, Courier, monospace;">emrepo:/oracle/app/product/11.2.0.4:N</span></div></div><div><br /></div><h4>Edit PFILE and Create SPFILE</h4><div>Then let's copy that parameter file into place.</div><div><br /></div><div><span style="font-family: Courier New, Courier, monospace;">$ . oraenv</span></div><div><div><span style="font-family: Courier New, Courier, monospace;">ORACLE_SID = [oracle] ? emrepo</span></div><div><span style="font-family: Courier New, Courier, monospace;">The Oracle base has been set to /oracle/app</span></div></div><div><span style="font-family: Courier New, Courier, monospace;">$ cd $ORACLE_HOME/dbs/</span></div><div><span style="font-family: Courier New, Courier, monospace;">$ cp /mnt/emrepo_backup/initemrepo.ora .</span></div><div><br /></div><div>Now edit that file and make sure you update the parameters that require updating. In my case, I'm using Oracle Managed Files (OMF) so I set db_create_file_dest and db_create_online_log_dest_1. I also set db_recovery_file_dest for the FRA. I then set the control_files parameter to specify where I want the control file(s) restored to from the backup when I get to that point.</div><div><br /></div><div>Now, Martin Bach noted in his blog post that he did not have to specify a db_file_name_convert or log_file_name_convert. I was having some difficulty during the restore phase, and added these parameters out of pure speculation. They didn't help the problem, but I left them in for the duration of my process. I only mention this as an FYI if you end up comparing your settings to mine.</div><div><br /></div><div>Once you have all your parameters set as desired, create the SPFILE:</div><div><br /></div><div><span style="font-family: Courier New, Courier, monospace;">$ sqlplus / as sysdba</span></div><div><span style="font-family: Courier New, Courier, monospace;">SQL&gt; create spfile from pfile;</span></div><div><br /></div><div>Now, let us restore ourselves the database.</div><h3></h3><h3>Restore Repo DB on New Host</h3><div>The restore was done largely as part of a ksh script, which I'll reference snippets of here. Let's start by defining some variables:</div><div><br /></div><span style="font-family: Courier New, Courier, monospace;">BACKUPDIR=/mnt/emrepo_backup<br />DESTDIR=/oracle/app/oradata/data/EMREPO</span><br /><h4><span style="font-family: inherit;"><br /></span></h4><h4><span style="font-family: inherit;">Restore Controlfile and Mount Database</span></h4><div><span style="font-family: inherit;">From the script, we call RMAN to start the instance in nomount mode, restore the controlfile from the specified backuppiece and mount the database:</span></div><div><span style="font-family: inherit;"><br /></span></div><div><span style="font-family: Courier New, Courier, monospace;"><span style="orphans: 2; text-align: -webkit-auto; widows: 2;">rman log=$LOGFILE &lt;&lt;EOF</span><br style="orphans: 2; text-align: -webkit-auto; widows: 2;" /><span style="orphans: 2; text-align: -webkit-auto; widows: 2;">connect target /</span></span></div><div><span style="orphans: 2; text-align: -webkit-auto; widows: 2;"><span style="font-family: Courier New, Courier, monospace;">set echo on</span></span></div><div><span style="font-family: Courier New, Courier, monospace;">startup force nomount;</span></div><span style="font-family: Courier New, Courier, monospace;">restore controlfile from '$BACKUPDIR/1abcd123_1_1';<br />alter database mount;</span><br /><div><span style="font-family: Courier New, Courier, monospace;">catalog start with '$BACKUPDIR' noprompt;</span></div><div><span style="font-family: Courier New, Courier, monospace;">EOF</span></div><div><span style="font-family: inherit;"><br /></span></div><div><span style="font-family: inherit;">We end by cataloging the backup files, as you can see.</span></div><div><span style="font-family: inherit;"><br /></span></div><h4><span style="font-family: inherit;">Generate SET NEWNAME Script</span></h4><div><span style="font-family: inherit;">Here I dip into sqlplus to generate an script for RMAN to call SET NEWNAME for each of the datafiles. Without this, RMAN would try to restore the datafiles to their old paths on the original host. Here I set them for the path that OMF will use:</span></div><div><span style="font-family: inherit;"><br /></span><br /><div><span style="font-family: Courier New, Courier, monospace;"><span style="orphans: 2; text-align: -webkit-auto; widows: 2;">sqlplus -s /nolog &lt;&lt;EOF</span></span></div><span style="orphans: 2; text-align: -webkit-auto; widows: 2;"><span style="font-family: Courier New, Courier, monospace;">connect / as sysdba</span></span></div><div><span style="font-family: Courier New, Courier, monospace;">set head off pages 0 feed off echo off verify off<br />set lines 200<br />spool rename_datafiles.rman<br />select 'set newname for datafile ' || FILE# || ' to ''' || '$DESTDIR/datafile/' || substr(name,instr(name,'/',-1)+1) || ''';' from v\$datafile;<br />select 'set newname for tempfile ' || FILE# || ' to ''' || '$DESTDIR/tempfile/' || substr(name,instr(name,'/',-1)+1) || ''';' from v\$tempfile;<br />spool off</span></div><div><span style="font-family: Courier New, Courier, monospace;">EOF</span></div><div><span style="font-family: inherit;"><br /></span></div><div><h4><span style="font-family: inherit;">Restore &amp; Recover Database</span></h4><div><span style="font-family: inherit;">Now we're ready to restore the database and perform recovery. Again, we call RMAN and run this:</span></div><div><span style="font-family: inherit;"><br /></span></div><span style="font-family: Courier New, Courier, monospace;">run {<br />&nbsp; allocate channel c1 device type disk;<br />&nbsp; allocate channel c2 device type disk;<br />&nbsp; allocate channel c3 device type disk;<br />&nbsp; allocate channel c4 device type disk;<br />&nbsp; @rename_datafiles.rman<br />&nbsp; restore database;<br />&nbsp; switch datafile all;<br />&nbsp; switch tempfile all;<br />&nbsp; recover database;<br />}</span><span style="font-family: inherit;"><br /></span><span style="font-family: inherit;"><br />At this point we're done with the restore and recovery. Normally I would OPEN RESETLOGS, but remember that we're restoring this to an 11.2.0.4 home, so we still need to UPGRADE the database!</span><br /><h3><span style="font-family: inherit;"><br /></span></h3><h3><span style="font-family: inherit;">Open and Upgrade Database</span></h3><div><span style="font-family: inherit;">First we still call OPEN RESETLOGS, but with the UPGRADE option. This replaces the "STARTUP UPGRADE" command you would find in the <a class="vt-p" href="http://docs.oracle.com/cd/E11882_01/server.112/e23633/upgrade.htm#UPGRD12408" target="_blank">manual upgrade instructions</a>.</span></div><div><span style="font-family: inherit;"><br /></span></div><span style="font-family: Courier New, Courier, monospace;">$ sqlplus / as sysdba<br />SQL&gt; alter database open resetlogs upgrade;</span></div><div><span style="font-family: inherit;"><br /></span></div><div><span style="font-family: inherit;">Now we follow the rest of the manual upgrade instructions, I'll just post the commands here, but you should definitely review the documentation:</span></div><div><span style="font-family: inherit;"><br /></span><span style="font-family: Courier New, Courier, monospace;">$ cd $ORACLE_HOME/rdbms/admin<br />$ sqlplus / as sysdba<br />SQL&gt; spool upgrade.log<br />SQL&gt; @catupgrd.sql</span></div><div><span style="font-family: Courier New, Courier, monospace;"><br /></span></div><div><span style="font-family: Courier New, Courier, monospace;">-- Start database again<br />SQL&gt; startup;</span></div><div><span style="font-family: Courier New, Courier, monospace;"><br /></span></div><div><span style="font-family: Courier New, Courier, monospace;">-- Check status of components, some will be fixed by utlrp.sql<br />SQL&gt; @utlu112s.sql</span></div><div><span style="font-family: Courier New, Courier, monospace;"><br /></span></div><div><span style="font-family: Courier New, Courier, monospace;">-- Rebuild everything<br />SQL&gt; @catuppst.sql<br />SQL&gt; @utlrp.sql</span></div><div><span style="font-family: Courier New, Courier, monospace;"><br />-- Confirm everything is OK now<br />SQL&gt; SELECT count(*) FROM dba_invalid_objects;<br />SQL&gt; SELECT distinct object_name FROM dba_invalid_objects;<br />SQL&gt; @utlu112s.sql</span><span style="font-family: inherit;"><br /></span><span style="font-family: inherit;"><br /></span>The utlu112s.sql should now report all components as VALID. If not, you'll want to refer to <a class="vt-p" href="http://docs.oracle.com/cd/E11882_01/server.112/e23633/upgrade.htm#UPGRD12409" target="_blank">the upgrade documentation for troubleshooting</a>.</div><div><span style="font-family: inherit;"><br /></span></div><div>At the point the database is upgraded and open. Make sure you have a listener running and that the new database is registered. The only thing &nbsp;left is the tell your OMS servers to look for the repository database in its new location.</div><div><br /></div><h3>Update OMS Repository Settings</h3><div>First we need to start just the administration server:</div><div><br /></div><div><span style="font-family: Courier New, Courier, monospace;">$ emctl start oms -admin_only</span></div><div><span style="font-family: inherit;"><br /></span></div><div>This is necessary if you used the "-all" option when stopping OMS earlier. If you did not use "-all" then the admin server should still be running.</div><div><span style="font-family: inherit;"><br /></span></div><div><span style="font-family: inherit;">Now, update the store_repos_details setting in the OMS configuration:</span></div><div><span style="font-family: inherit;"><br /></span><span style="font-family: Courier New, Courier, monospace;">$ emctl config oms -store_repos_details -repos_port 1521 \</span></div><div><span style="font-family: Courier New, Courier, monospace;">&nbsp; -repos_sid emrepo -repos_host newhost.mydomain.com \</span></div><div><span style="font-family: Courier New, Courier, monospace;">&nbsp; -repos_user sysman -repos_pwd xxx</span></div><div><span style="font-family: inherit;"><br /></span></div><div><span style="font-family: inherit;">Repeat this step for all your OMS servers (emctl should remind you to do so when changing the config). Then on each, completely shutdown and restart OMS:</span></div><div><span style="font-family: inherit;"><br /></span><span style="font-family: Courier New, Courier, monospace;">$ emctl stop oms -all<br />$ emctl start oms</span></div><div><span style="font-family: inherit;"><br /></span></div><div><span style="font-family: inherit;">And that should be it! Don't forget to drop/delete the database from the original server when you're comfortable doing so.</span></div>